---
title: "Useful extra bits of code"
output: html_notebook
---

## Extras

### Old way of plotting microtitre plates

The previous way of plotting plates broke. 

The packages involved are:
ggplot2 3.2.1 (web instance) vs 3.3.2 (here)
ggplot2bdc 0.3.2 (web instance) vs. 0.3.2 (here) 

Something happened in the ggplot2 update that meant the title and guides were superimposed on the plot. The specific issue was with the scale_y_reverse() function.

```{r}
sample_map <- ggplot(data=table_platemap, aes(x=Column, y=Row)) +
  #set up the platemap layout
    geom_point(data=expand.grid(seq(1, 12), seq(1, 8)), aes(x=Var1, y=Var2), color="grey90", fill="white", shape=21, size=6) +
  #Change the shape and colour of points for a variable
  geom_point(aes(colour = filtered_pc)) +
  #change the colours
  scale_colour_viridis_c(guide = "colourbar", na.value="white") +
  #fix the ratio of coordinates
    coord_fixed(ratio=(13/12)/(9/8), xlim=c(0.5, 12.5), ylim=c(0.5, 8.5)) +
  #add labels for the y axis
    scale_y_reverse(breaks=seq(1, 8), labels=LETTERS[1:8]) +
  #add labels for the x axis
    scale_x_continuous(breaks=seq(1, 12)) +
  #Add a title
    labs(title="The position of cells that failed QC" , size = 6, colour = "percentage of cells in this well that failed QC") +
  #rotate legend guide because otherwise you can't see numbers:
    guides(fill = guide_colorbar(barwidth = 0.5, barheight = 10, title="Value")) +
  #change the colours
    #scale_color_manual(values=c("Hoechst"="blue", "Hoescht" = "blue", "mCherry"="red", "GFP"="green")) +
  # make mimnimum point size bigger
    #scale_size_continuous(range = c(2,10)) +
  # make into a plate plot
    theme_bdc_microtiter()

sample_map
```

### Sex ratio plots

Calculate sex ratios
```{r}
## this will only subset SS2 cells as these are the only ones with identities

## subset males
ss2_mutants_final_male <- SubsetData(ss2_mutants_final, ident.use = c(1,10,13,16))

## subset females
ss2_mutants_final_female <- SubsetData(ss2_mutants_final, ident.use = c(0,9,11,14,15,5))

## inspect
ss2_mutants_final_male
ss2_mutants_final_female
```

```{r}
## calculate sex ratios
##subset out H+ sorted cells:
df_male <- ss2_mutants_final_male@meta.data[ss2_mutants_final_male@meta.data$exclude_for_sex_ratio == FALSE,]

dim(df_male)

df_female <- ss2_mutants_final_female@meta.data[ss2_mutants_final_female@meta.data$exclude_for_sex_ratio == FALSE,]

dim(df_female)

## make dataframe
df_sex_ratio <- merge(
  as.data.frame(table(df_male$sub_identity_updated)), 
  as.data.frame(table(df_female$sub_identity_updated)), 
  by = "Var1", all=TRUE)

# or use identity_updated

## add names
names(df_sex_ratio) <- c("genotype", "male", "female")

## change the NAs to 0
df_sex_ratio[is.na(df_sex_ratio)] <- 0

## calculate sex ratio
df_sex_ratio$sex_ratio <- (df_sex_ratio$male + 1)/(df_sex_ratio$female)

## log sex ratio
df_sex_ratio$sex_ratio_log <- log10(df_sex_ratio$sex_ratio)

##view
df_sex_ratio
```

plot
```{r}
## reorder genotype so it is in the correct order for plotting
#df_sex_ratio$genotype <- factor(df_sex_ratio$genotype, levels = c("GCSKO-2", "GCSKO-3", "WT-3", "GCSKO-10_820", "GCSKO-13", "WT-13", "GCSKO-17", "WT-17", "GCSKO-19", "WT-19", "GCSKO-20", "WT-20", "GCSKO-glasgow", "GCSKO-28", "GCSKO-29", "GCSKO-oom", "WT-820"))

## make extra column for plotting aesthetics:
df_sex_ratio$above <- df_sex_ratio$sex_ratio_log > 1

## plot
ggplot(df_sex_ratio, aes(sex_ratio_log, reorder(genotype, sex_ratio_log, sum), color = above)) +
      geom_segment(aes(x = 1, y = genotype, xend = sex_ratio_log, yend = genotype), color = "grey50") +
      geom_point() +
      annotate("rect", xmin= -0.30103000, xmax = 1.02118930, ymin=-Inf , ymax=Inf, alpha=0.1, color=NA,linetype = 2, fill="blue") +
        theme_classic()
  
## https://uc-r.github.io/lollipop
```

### UMAP optimisation

try to make a better UMAP:
```{r}
for(i in c(20,200,400,800,1200)){
ss2.mca.integrated <- RunUMAP(ss2.mca.integrated, reduction = "pca", dims = 1:21, seed.use = i)

assign(paste0("UMAP_", i) ,DimPlot(ss2.mca.integrated, reduction = "umap", group.by = "RNA_snn_res.1", label = TRUE, repel = TRUE, pt.size = 0.01) + coord_fixed())
}
```

```{r}
UMAP_20
UMAP_200
UMAP_400
UMAP_800
UMAP_1200
```